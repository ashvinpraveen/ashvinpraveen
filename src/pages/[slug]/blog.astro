---
import BaseHead from '../../components/BaseHead.astro';
import CardLayout from '../../components/CardLayout.astro';
import GlobalEditToggle from '../../components/GlobalEditToggle.astro';
export const prerender = false;

const { slug } = Astro.params;
const user = await Astro.locals.currentUser();

// For now, we'll check if the slug matches the current user
// In the future, this could query a database for public profiles
let isOwner = false;
if (user) {
  const userSlug = user.username || user.primaryEmailAddress?.emailAddress?.split('@')[0] || '';
  isOwner = userSlug.toLowerCase() === slug?.toLowerCase();
}

// For demo purposes, we'll show the page if it's the owner or if it's a known slug
const pageTitle = `${slug}'s Blog`;
const pageDescription = `Blog posts by ${slug}`;
---

<!doctype html>
<html lang="en" data-theme="dark">
	<head>
		<BaseHead title={pageTitle} description={pageDescription} />
		<script src="https://unpkg.com/@tiptap/core@2.1.16/dist/index.umd.min.js"></script>
		<script src="https://unpkg.com/@tiptap/pm@2.1.16/dist/index.umd.min.js"></script>
		<script src="https://unpkg.com/@tiptap/starter-kit@2.1.16/dist/index.umd.min.js"></script>
		<script src="https://unpkg.com/@tiptap/extension-placeholder@2.1.16/dist/index.umd.min.js"></script>
		<script src="https://unpkg.com/@tiptap/extension-link@2.1.16/dist/index.umd.min.js"></script>
	</head>
	<body>
		<CardLayout>
			<main>
				<div class="page-header">
					<h1 class="page-title editable-text" contenteditable="false" data-field="blog-title" id="page-title">
						{slug}'s Blog
					</h1>
				</div>

				<div class="editor-container">
					<div id="editor" class="tiptap-editor"></div>
				</div>
			</main>
		</CardLayout>
		<GlobalEditToggle isOwner={isOwner} />

		<style>
			main {
				max-width: none;
				padding: 2rem;
			}

			.page-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 2rem;
				padding-bottom: 1rem;
				border-bottom: 1px solid hsl(0 0% 100% / 0.1);
			}

			.page-title {
				margin: 0;
				font-size: 2rem;
				font-weight: 700;
				color: hsl(0 0% 100% / 0.97);
				outline: none;
				border-radius: 4px;
				padding: 0.25rem 0.5rem;
				transition: background 0.2s ease;
			}

			.page-title.editing-active {
				background: hsl(0 0% 100% / 0.05);
				border: 1px solid hsl(0 0% 100% / 0.2);
			}


			.editor-container {
				max-width: 65ch;
				margin: 0 auto;
			}

			.tiptap-editor {
				min-height: 500px;
				outline: none;
				color: hsl(0 0% 100% / 0.92);
				line-height: 1.6;
			}

			.tiptap-editor p {
				margin-bottom: 1rem;
			}

			.tiptap-editor h1,
			.tiptap-editor h2,
			.tiptap-editor h3 {
				color: hsl(0 0% 100% / 0.97);
				margin: 1.5rem 0 1rem 0;
				font-weight: 600;
			}

			.tiptap-editor h1 {
				font-size: 1.875rem;
			}

			.tiptap-editor h2 {
				font-size: 1.5rem;
			}

			.tiptap-editor h3 {
				font-size: 1.25rem;
			}

			.tiptap-editor ul,
			.tiptap-editor ol {
				padding-left: 1.5rem;
				margin-bottom: 1rem;
			}

			.tiptap-editor li {
				margin-bottom: 0.25rem;
			}

			.tiptap-editor blockquote {
				border-left: 3px solid hsl(0 0% 100% / 0.3);
				padding-left: 1rem;
				margin: 1rem 0;
				color: hsl(0 0% 100% / 0.8);
				font-style: italic;
			}

			.tiptap-editor code {
				background: hsl(0 0% 100% / 0.1);
				padding: 0.125rem 0.25rem;
				border-radius: 4px;
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.875rem;
			}

			.tiptap-editor pre {
				background: hsl(0 0% 100% / 0.05);
				padding: 1rem;
				border-radius: 8px;
				overflow-x: auto;
				margin: 1rem 0;
			}

			.tiptap-editor pre code {
				background: none;
				padding: 0;
			}

			/* Placeholder styles */
			.tiptap-editor p.is-editor-empty:first-child::before {
				color: hsl(0 0% 100% / 0.4);
				content: attr(data-placeholder);
				float: left;
				height: 0;
				pointer-events: none;
			}
		</style>

		<script define:vars={{ isOwner, slug }}>
			let editor = null;
			let isEditMode = false;

			// Initialize editor when page loads
			document.addEventListener('DOMContentLoaded', function() {
				if (typeof window.TiptapCore !== 'undefined') {
					initializeEditor();
				} else {
					// Wait a bit more for scripts to load
					setTimeout(initializeEditor, 500);
				}

				// Listen for global edit mode changes
				window.addEventListener('editModeChanged', function(e) {
					isEditMode = e.detail.isEditMode;
					if (editor) {
						editor.setEditable(isOwner && isEditMode);
					}
				});
			});

			function initializeEditor() {
				try {
					editor = new window.TiptapCore.Editor({
						element: document.querySelector('#editor'),
						extensions: [
							window.TiptapStarterKit.default,
							window.TiptapExtensionPlaceholder.default.configure({
								placeholder: isOwner ? 'Start writing your blog posts...' : 'No content yet.',
							}),
							window.TiptapExtensionLink.default.configure({
								openOnClick: false,
							}),
						],
						content: getInitialContent(),
						editable: false,
						editorProps: {
							attributes: {
								class: 'tiptap-editor',
							},
						},
					});

					// Set initial edit mode based on saved state
					const savedMode = localStorage.getItem('editMode') === 'true';
					if (savedMode && isOwner) {
						isEditMode = true;
						editor.setEditable(true);
					}
				} catch (error) {
					console.error('Failed to initialize editor:', error);
					// Fallback: show a simple textarea
					document.querySelector('#editor').innerHTML = `
						<div style="color: hsl(0 0% 100% / 0.6); text-align: center; padding: 2rem;">
							${isOwner ? 'Start writing your blog posts...' : 'No content yet.'}
						</div>
					`;
				}
			}

			function getInitialContent() {
				// In a real app, this would load from a database
				return `
					<h2>Welcome to ${slug}'s Blog</h2>
					<p>This is where ${slug} shares thoughts, ideas, and stories.</p>
					${isOwner ? '<p>Click "Edit" to start writing your first post!</p>' : ''}
				`;
			}

		</script>
	</body>
</html>