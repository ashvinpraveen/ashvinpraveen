---
import BaseHead from "../components/BaseHead.astro";
import CardLayout from "../components/CardLayout.astro";
import GlobalEditToggle from "../components/GlobalEditToggle.astro";
import EnhancedTipTapEditor from "../components/EnhancedTipTapEditor.astro";
import ConvexProviderWrapper from "../components/ConvexProviderWrapper.tsx";
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../convex/_generated/api';

export async function getStaticPaths() {
  return [];
}
export const prerender = false;

const { slug } = Astro.params;
const user = await Astro.locals.currentUser();
const auth = Astro.locals.auth();
let isOwner = false;

// Resolve slug (handles old aliases) and load settings for SEO if available
let siteSettings: any = null;
try {
  const client = new ConvexHttpClient(import.meta.env.CONVEX_URL || import.meta.env.PUBLIC_CONVEX_URL);
  const resolved = await client.query(api.sites.resolveSlug, { slug });
  if (resolved?.redirect && resolved?.canonicalSlug) {
    return Astro.redirect(`/${resolved.canonicalSlug}`);
  }
  siteSettings = resolved?.site ? await client.query(api.sites.getSettings, { slug: resolved.canonicalSlug }) : await client.query(api.sites.getSettings, { slug });
  if (user?.id) {
    const sites = await client.query(api.sites.listSitesForClerk, { clerkUserId: user.id });
    const canonical = (resolved?.canonicalSlug || slug).toLowerCase();
    isOwner = Array.isArray(sites) && sites.some((s: any) => (s?.slug || '').toLowerCase() === canonical);
  }
} catch {}

const pageTitle = siteSettings?.seoTitle || `${slug.charAt(0).toUpperCase() + slug.slice(1)}'s Profile`;
const pageDescription = siteSettings?.seoDescription || `Welcome to ${slug}'s personal profile page`;
---

<!doctype html>
<html lang="en" data-theme="dark">
	<head>
		<BaseHead title={pageTitle} description={pageDescription} imageUrl={siteSettings?.ogImageId ? `/api/images/${siteSettings.ogImageId}` : undefined} />
		<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
	</head>
	<body data-is-owner={isOwner} data-slug={slug}>
		<CardLayout>
			<main>
				<!-- ============================================ -->
				<!-- ENHANCED TIPTAP EDITOR FOR PROFILE PAGE -->
				<!-- ============================================ -->
				<EnhancedTipTapEditor
					id="profile-editor"
					placeholder={isOwner ? 'Start writing your profile...' : 'No profile content yet.'}
					editable={false}
					showBubbleMenu={true}
					showContextMenu={true}
					showUploadModal={true}
					isOwner={isOwner}
					slug={slug}
					pageKey="profile"
					class="editor-container"
				/>
			</main>
		</CardLayout>
		<GlobalEditToggle isOwner={isOwner} />

		<!-- Convex Provider Wrapper for Real-time Streaming -->
		<ConvexProviderWrapper key="profile-page" slug={slug} editorId="profile-editor" isOwner={isOwner} pageKey="profile" pageTitle="Profile" client:load />

		<!-- ============================================ -->
		<!-- MINIMAL STYLES FOR EDITOR CONTAINER -->
		<!-- ============================================ -->
		<style>
			/* Override global main constraints for full-width editor with high specificity */
			:global(.content-area) main {
				max-width: none !important;
				padding: 0rem !important;
				margin: 0 !important;
				width: 100% !important;
			}

			/* Additional overrides to ensure full width */
			.content-area main {
				max-width: none !important;
				padding: 0rem !important;
				margin: 0 !important;
				width: 100% !important;
			}

			main {
				max-width: none !important;
				padding: 0rem !important;
				margin: 0 !important;
				width: 100% !important;
			}

			.editor-container {
				width: 100%;
				max-width: none;
				margin: 0;
				position: relative;
				overflow: visible;
			}
		</style>

		<!-- ============================================ -->
		<!-- INITIALIZE EDIT MODE FROM GLOBAL TOGGLE -->
		<!-- ============================================ -->
		<script type="module">
			console.log('üö® Profile page script starting to load...');
			let isEditMode = false;

			// Get page configuration from data attributes
			function getPageConfig() {
				const bodyElement = document.body;
				return {
					isOwner: bodyElement.dataset.isOwner === 'true',
					slug: bodyElement.dataset.slug
				};
			}

			// Initialize when page loads
			document.addEventListener('DOMContentLoaded', function() {
				console.log('üåü Profile page DOM loaded, starting initialization...');
				const config = getPageConfig();
				console.log('‚öôÔ∏è Page config:', config);
				console.log('üîß Profile page loaded, setting up edit mode integration...');

				// Listen for global edit mode changes
				window.addEventListener('editModeChanged', function(e) {
					isEditMode = e.detail.isEditMode;

					// Get the enhanced editor instance
					const editorInstance = window[`profile-editorEditor`];
					if (editorInstance && editorInstance.getEditor()) {
						const shouldBeEditable = config.isOwner && isEditMode;
						editorInstance.setEditable(shouldBeEditable);
					}
				});

				// Set initial edit mode based on saved state
				const savedMode = localStorage.getItem('editMode') === 'true';
				if (savedMode && config.isOwner) {
					isEditMode = true;
					// Trigger the event to update editor
					window.dispatchEvent(new CustomEvent('editModeChanged', {
						detail: { isEditMode: true }
					}));
				}

				// Initialize Lucide icons
				if (typeof lucide !== 'undefined') {
					lucide.createIcons();
				}
			});
		</script>
	</body>
</html>
