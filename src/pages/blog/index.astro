---
import BaseHead from '../../components/BaseHead.astro';
import CardLayout from '../../components/CardLayout.astro';
import GlobalEditToggle from '../../components/GlobalEditToggle.astro';
import BlogList from '../../components/BlogList.astro';
import EnhancedTipTapEditor from '../../components/EnhancedTipTapEditor.astro';
import ConvexProviderWrapper from '../../components/ConvexProviderWrapper.tsx';
export const prerender = false;

const user = await Astro.locals.currentUser();
// For public blog page, only admins can edit
const isOwner = user?.username === 'ashvin' || user?.primaryEmailAddress?.emailAddress === 'ashvin@cleve.ai' || user?.primaryEmailAddress?.emailAddress === 'ashvinpraveen@gmail.com';

const pageTitle = 'Blog';
const pageDescription = 'Latest thoughts and ideas';

// Default content for blog header
const defaultBlogHeader = '<h1>Blog</h1><p>Here\'s a collection of some thoughts and notes to self</p>';
---

<!doctype html>
<html lang="en" data-theme="dark">
	<head>
		<BaseHead title={pageTitle} description={pageDescription} isUserPage={false} />
		<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
	</head>
	<body data-is-owner={isOwner} data-slug="public-blog">
		<CardLayout>
			<main>
				<!-- Editable Blog Header -->
				<div class="blog-header-container">
					<EnhancedTipTapEditor
						id="public-blog-header-editor"
						placeholder={isOwner ? 'Write your blog header...' : 'No blog header yet.'}
						content={defaultBlogHeader}
						editable={false}
						showBubbleMenu={false}
						showContextMenu={true}
						showUploadModal={false}
						isOwner={isOwner}
						slug="homepage"
						pageKey="public-blog-header"
						class="blog-header-editor"
					/>
				</div>

				<!-- Blog Posts List -->
				<BlogList slug="homepage" isOwner={isOwner} />

				<!-- Floating New Post Button -->
				{isOwner && (
					<button class="floating-new-post-btn" id="public-new-post-btn">
						<i data-lucide="plus"></i>
					</button>
				)}
			</main>
		</CardLayout>

		<GlobalEditToggle isOwner={isOwner} />

		<!-- Convex Provider Wrapper for Blog Header -->
		<ConvexProviderWrapper
			slug="homepage"
			editorId="public-blog-header-editor"
			isOwner={isOwner}
			pageKey="public-blog-header"
			pageTitle="Blog Header"
			client:load
		/>

		<style>
			/* Remove main container padding since TipTap has its own */
			:global(.content-area) main {
				padding: 0 !important;
			}

			.content-area main {
				padding: 0 !important;
			}

			main {
				padding: 0 !important;
			}

			/* Blog Header Container - remove min-height from TipTap */
			.blog-header-container {
				margin-bottom: 0;
			}

			.blog-header-editor {
				width: 100%;
			}

			/* Override TipTap min-height and padding for header with maximum specificity */
			:global(div.blog-header-container div.blog-header-editor.enhanced-tiptap-editor) {
				min-height: 0rem !important;
				padding: 3rem 3rem 0rem 3rem !important;
				margin: 0 0 2rem 0 !important;
			}

			:global(div.blog-header-container div.blog-header-editor.enhanced-tiptap-editor .ProseMirror) {
				min-height: 0rem !important;
				padding-bottom: 0rem !important;
			}

			:global(#public-blog-header-editor) {
				min-height: 0rem !important;
				padding: 3rem 3rem 0rem 3rem !important;
				margin: 0 0 2rem 0 !important;
			}

			:global(#public-blog-header-editor .ProseMirror) {
				min-height: 0rem !important;
				padding-bottom: 0rem !important;
			}

			/* Add padding to blog list container */
			:global(.posts-container) {
				padding: 0 3rem 3rem 3rem;
			}

			/* Floating New Post Button */
			.floating-new-post-btn {
				position: fixed;
				bottom: 2rem;
				right: 2rem;
				width: 56px;
				height: 56px;
				background: hsl(0 0% 100% / 0.05);
				backdrop-filter: blur(20px);
				border: 1px solid hsl(0 0% 100% / 0.15);
				border-radius: 50%;
				color: hsl(0 0% 100% / 0.8);
				cursor: pointer;
				transition: all 0.2s ease;
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 1000;
			}

			.floating-new-post-btn:hover {
				background: hsl(0 0% 100% / 0.1);
				color: hsl(0 0% 100% / 0.95);
			}

			.floating-new-post-btn i {
				width: 20px;
				height: 20px;
				stroke-width: 1;
			}

			/* Responsive */
			@media (max-width: 768px) {
				/* Blog list responsive padding */
				:global(.posts-container) {
					padding: 0 2rem 2rem 2rem;
				}

				.floating-new-post-btn {
					bottom: 1.5rem;
					right: 1.5rem;
					width: 50px;
					height: 50px;
				}
			}
		</style>

		<script type="module">
			console.log('ðŸš¨ Public blog page script starting to load...');
			let isEditMode = false;

			// Get page data from body attributes
			const isOwner = document.body.dataset.isOwner === 'true';
			const slug = document.body.dataset.slug;

			// Generate unique ID for new posts
			function generateUniqueId() {
				return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
			}

			// New post handler for public blog
			function handlePublicNewPost() {
				if (!isOwner) return;
				alert('âœ¨ This would create a new blog post in the public blog. Feature coming soon!');
			}

			// Initialize when page loads
			document.addEventListener('DOMContentLoaded', function() {
				console.log('ðŸŒŸ Public blog page DOM loaded, starting initialization...');

				// New post button (floating)
				document.getElementById('public-new-post-btn')?.addEventListener('click', handlePublicNewPost);

				// Listen for global edit mode changes
				window.addEventListener('editModeChanged', function(e) {
					isEditMode = e.detail.isEditMode;

					// Get the enhanced editor instance
					const editorInstance = window[`public-blog-header-editorEditor`];
					if (editorInstance && editorInstance.getEditor()) {
						const shouldBeEditable = isOwner && isEditMode;
						editorInstance.setEditable(shouldBeEditable);
					}
				});

				// Set initial edit mode based on saved state
				const savedMode = localStorage.getItem('editMode') === 'true';
				if (savedMode && isOwner) {
					isEditMode = true;
					// Trigger the event to update editor
					window.dispatchEvent(new CustomEvent('editModeChanged', {
						detail: { isEditMode: true }
					}));
				}

				// Initialize Lucide icons
				if (typeof lucide !== 'undefined') {
					lucide.createIcons();
				}
			});
		</script>
	</body>
</html>