---
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../../convex/_generated/api';
export const prerender = false;

const user = await Astro.locals.currentUser();
if (!user) {
  return Astro.redirect('/sign-in');
}
const preferredUsername = user.username || user.primaryEmailAddress?.emailAddress?.split('@')[0] || 'user';
let siteSlug = preferredUsername;
try {
  const client = new ConvexHttpClient(import.meta.env.CONVEX_URL || import.meta.env.PUBLIC_CONVEX_URL);
  const sites = await client.query(api.sites.listSitesForClerk, { clerkUserId: user.id });
  const site = Array.isArray(sites) && sites[0] || null;
  if (site) siteSlug = site.slug;
} catch {}
return Astro.redirect(`/${siteSlug}/settings`);
---
